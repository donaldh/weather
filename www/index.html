<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Carlston Cottage Weather</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
          integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <script src="//d3js.org/d3.v3.min.js" Charset="utf-8"></script>
    <style>
      .axis text {
          font: 10px sans-serif;
      }

      .jumbotron {
          padding-top: 1em;
          padding-bottom: 1em;
      }

      .jumbotron h1 {
          font-size: 32pt;
      }

      .jumbotron p {
          font-size: 14pt;
      }

      .line {
          stroke: blue;
          stroke-width: 1;
          fill: none;
      }

      .axis line,
      .axis path {
          fill: none;
          stroke: #000;
          shape-rendering: crispEdges;
      }

      .grid .tick {
          stroke: lightgrey;
          opacity: 0.7;
      }

      .grid path {
          stroke-width: 0;
      }
    </style>
  </head>
  <body>
    <div class="jumbotron">
      <div class="container">
        <h1>Carlston Cottage</h1>
        <p class="lead">This is a summary of the recent weather at Carlston Cottage.</p>
      </div>
    </div>
    <div class="container">
      <div id="now" class="alert alert-info">Loading ...</div>
      <div id="celsius"></div>
      <div id="speed"></div>
      <div id="buttons" class="btn-group" role="group">
        <button type="button" class="btn" onclick="weather('six')">6 hours</button>
        <button type="button" class="btn" onclick="weather('half')">12 hours</button>
        <button type="button" class="btn" onclick="weather('day')">24 hours</button>
      </div>
      <script>
        var width = d3.select("#now").node().getBoundingClientRect().width,
            height = 300,
            padding = 25;
        var nowDiv = d3.select("#now");

        var chart = function(id, width, height, yIndex) {
            this.svg = d3.select(id)
                        .append('svg').attr('width', width).attr('height', height)
                        .append('g').attr('transform', 'translate(' + padding + ',0)');

            this.x = d3.time.scale().domain([new Date(), new Date()]).range([0, width - padding * 2]);
            this.y = d3.scale.linear().domain([-5, 20]).range([height - padding, padding]);

            var self = this;
            this.line = d3.svg.line()
                          .x(function(d) { return self.x(d[0]); })
                          .y(function(d) { return self.y(d[yIndex]); })
                          .interpolate('linear');

            this.x.grid = d3.svg.axis().scale(this.x)
                            .orient('bottom')
                            .tickSize(-(height - padding * 2), 0, 0)
                            .tickFormat('');
            this.xgrid = this.svg.append('g').attr('class', 'grid')
                             .attr('transform', 'translate(0, ' + (height - padding) + ')')
                             .call(this.x.grid);

            this.y.grid = d3.svg.axis().scale(this.y)
                            .orient('left')
                            .tickSize(-(width - padding * 2), 0, 0)
                            .tickFormat('');
            this.ygrid = this.svg.append('g').attr('class', 'grid')
                             .call(this.y.grid);

            this.x.axis = d3.svg.axis().scale(this.x).orient('bottom');
            this.xaxis = this.svg.append('g').attr('class', 'x axis')
                             .attr('transform', 'translate(0, ' + (height - padding) + ')')
                             .call(this.x.axis);

            this.y.axis = d3.svg.axis().scale(this.y).orient('left');
            this.yaxis = this.svg.append('g').attr('class', 'y axis')
                             .call(this.y.axis);

            this.path = this.svg.append('path')
                            .datum([])
                            .attr('d', this.line)
                            .attr('class', 'line');

            this.update = function(data, min, max) {
                data.forEach(function(d) { d[0] = new Date(d[0]); });
                this.x.domain([min, max]);

                this.path.datum(data);

                this.svg.select('.line')
                    .transition().attr('d', this.line);
                this.xgrid.transition().call(this.x.grid);
                this.ygrid.transition().call(this.y.grid);
                this.xaxis.transition().call(this.x.axis);
                this.yaxis.transition().call(this.y.axis);
            }
        }

        var celsius = new chart('#celsius', width, height, 1);
        var speed = new chart('#speed', width, height, 2);

        var weather = function(duration) {
            d3.json('//' + document.location.hostname + ':8000/' + duration, function(error, json) {
                if (error) return console.warn(error);

                nowDiv.text(new Date(json.now[0]) + " - Currently " + json.now[1] + " Celsius");

                var xMin = new Date(json.start),
                    xMax = new Date(json.end);
                var data = json.data;

                celsius.update(data, xMin, xMax);
                speed.update(data, xMin, xMax);
            });
        };

        weather('six');
      </script>
    </div>
  </body>
</html>
