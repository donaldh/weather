<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Carlston Cottage Weather</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
          integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <style>
      .axis text {
          font: 10px sans-serif;
      }

      .line {
          stroke: blue;
          stroke-width: 1;
          fill: none;
      }

      .axis line,
      .axis path {
          fill: none;
          stroke: #000;
          shape-rendering: crispEdges;
      }

      .grid .tick {
          stroke: lightgrey;
          opacity: 0.7;
      }

      .grid path {
          stroke-width: 0;
      }
    </style>
  </head>
  <body>
    <div class="jumbotron">
      <div class="container">
        <h1>Carlston Cottage</h1>
        <p class="lead">This is a summary of the recent weather at Carlston Cottage.</p>
      </div>
    </div>
    <div class="container">
      <div id="now" class="alert alert-info">Loading ...</div>
      <div id="weather"></div>
      <div id="buttons" class="btn-group" role="group">
        <button type="button" class="btn" onclick="weather('six')">6 hours</button>
        <button type="button" class="btn" onclick="weather('half')">12 hours</button>
        <button type="button" class="btn" onclick="weather('day')">24 hours</button>
      </div>
      <script>
        var width = d3.select("#weather").node().getBoundingClientRect().width, height = 350, padding = 25;
        var nowDiv = d3.select("#now");
        var svg = d3.select("#weather")
                    .append('svg').attr('width', width).attr('height', height)
                    .append('g').attr('transform', 'translate(' + padding + ',0)');

        var x = d3.time.scale().domain([new Date(), new Date()]).range([0, width - padding * 2]);
        var y = d3.scale.linear().domain([-5, 20]).range([height - padding, padding]);

        var line = d3.svg.line()
                     .x(function(d) { return x(d[0]); })
                     .y(function(d) { return y(d[1]); })
                     .interpolate('linear');

        x.grid = d3.svg.axis().scale(x).orient('bottom').tickSize(-(height - padding * 2), 0, 0).tickFormat('');
        var xgrid = svg.append('g').attr('class', 'grid')
                       .attr('transform', 'translate(0, ' + (height - padding) + ')')
                       .call(x.grid);

        y.grid = d3.svg.axis().scale(y).orient('left').tickSize(-(width - padding * 2), 0, 0).tickFormat('');
        var ygrid = svg.append('g').attr('class', 'grid')
                       .call(y.grid);

        x.axis = d3.svg.axis().scale(x).orient('bottom');
        var xaxis = svg.append('g').attr('class', 'x axis')
                       .attr('transform', 'translate(0, ' + (height - padding) + ')')
                       .call(x.axis);

        y.axis = d3.svg.axis().scale(y).orient('left');
        var yaxis = svg.append('g').attr('class', 'y axis')
                       .call(y.axis);

        var path = svg.append('path')
                      .datum([])
                      .attr('d', line)
                      .attr('class', 'line');

        var weather = function(duration) {
            d3.json('//' + document.location.hostname + ':8000/' + duration, function(error, json) {
                if (error) return console.warn(error);

                nowDiv.text(new Date(json.now[0]) + " - Currently " + json.now[1] + " Celsius");

                var xMin = new Date(json.start), xMax = new Date(json.end);
                var data = json.data;
                data.forEach(function(d) { d[0] = new Date(d[0]); });
                x.domain([xMin, xMax]);

                path.datum(data);

                svg.select('.line')
                   .transition().attr('d', line);
                xgrid.transition().call(x.grid);
                ygrid.transition().call(y.grid);
                xaxis.transition().call(x.axis);
                yaxis.transition().call(y.axis);
            });
        };

        weather('six');
      </script>
    </div>
  </body>
</html>
